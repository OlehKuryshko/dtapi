stages:
  - build
  - deploy

services:
- docker:dind

letsbuildit:
  image: docker:latest
  stage: build
  script:
    - docker login registry.gitlab.com -u ${USERNAME} -p ${REGISTRY_PASSWORD}
    - docker build -t registry.gitlab.com/oleh_kuryshko/dtapi:${CI_PIPELINE_ID} .
    - docker push registry.gitlab.com/oleh_kuryshko/dtapi:${CI_PIPELINE_ID}
  tags:
    - backend-runner

deploytoprod:
  image: google/cloud-sdk:latest
  stage: deploy
  script:
    - sed -i "s/IMAGE_TAG/${CI_PIPELINE_ID}/g" ci/svc-dp-bk.yml
    - echo ${GOOGLE_KEY} > key.json
    - gcloud auth activate-service-account --key-file key.json
    - gcloud container clusters get-credentials d-tester-claster --zone us-central1-f --project ${PROJECT_ID}
    - gcloud config set container/use_client_certificate True
    - kubectl apply -f ci/svc-dp-bk.yml
  when: manual
  tags:
    - backend-runner
#start